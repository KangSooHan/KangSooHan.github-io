<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Whale</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/mobile.css">
    <link rel="stylesheet" href="/assets/css/vendor/syntax.css">
    <link rel="stylesheet" href="/assets/css/vendor/semantic.min.css"/>

    <link rel="shortcut icon" type="image/png" href="/assets/img/logo.png"/>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">
</head>


<body>
    
    <div class="page-wrap">
        <div class="header-wrapper">
    <header>
        <!-- logo and description -->
        
        <nav class="site-nav">
            <div class="left-nav">
                <!-- add titles to all buttons -->
                <div class="ui secondary menu inverted">
                    <a class="item" href="/">
                        Home
                    </a>
                    <a class="item" href="/about.html">
                        About
                    </a>
                    <a class="item" href="/archive.html">
                        Archive
                    </a>
                    <div class="right menu">
                        <a class="item" href="https://facebook.com/tkatjdrkd">
                            <i class="facebook link icon"></i>
                        </a>
                        <a class="item" href="https://www.instagram.com/soohan.getjy/">
                            <i class="instagram link icon"></i>
                        </a>
                        <a class="item" href="https://github.com/KangSooHan">
                            <i class="github link icon"></i>
                        </a>
                    </div>
                </div>
            </div>
            <div class="right-nav"></div>
        </nav>
    </header>
</div>

        <main>
            <div class="post-container">
    <center>
        <span class="date">
            02 Jan 2023 
             
                in <i>sensorfusion</i>
             
        </span>
        <h1 class="post-title">Highway Simulation - Lider 부수기</h1>
    </center>
    <div class="ui divider"></div>
    <h3 id="highway-simulation">Highway Simulation</h3>

<h3 id="lidar-부수기">Lidar 부수기</h3>

<h4 id="main-함수">main 함수</h4>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">simpleHighway</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">viewer</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// RENDER OPTIONS</span>
    <span class="kt">bool</span> <span class="n">renderScene</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">cars</span> <span class="o">=</span> <span class="n">initHighway</span><span class="p">(</span><span class="n">renderScene</span><span class="p">,</span> <span class="n">viewer</span><span class="p">);</span>

    <span class="c1">// Lidar 함수 파해치기!!</span>
    <span class="n">Lidar</span><span class="o">*</span> <span class="n">lidar</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Lidar</span><span class="p">(</span><span class="n">cars</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span> <span class="n">cloud</span> <span class="o">=</span> <span class="n">lidar</span><span class="o">-&gt;</span><span class="n">scan</span><span class="p">();</span>
    <span class="n">renderRays</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">lidar</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">,</span> <span class="n">cloud</span><span class="p">);</span>

    <span class="n">renderPointCloud</span><span class="p">(</span><span class="n">viewer</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="s">"highwayScene"</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="nc">Lidar</span>
<span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Ray</span><span class="o">&gt;</span> <span class="n">rays</span><span class="p">;</span>
    <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span> <span class="n">cloud</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;</span> <span class="n">cars</span><span class="p">;</span>

    <span class="n">Lidar</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// Vertical Angle 가장 가파른 steepestAngle부터 angleRange까지 angleIncrement(angleRange/numLayers) 단위로</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">angleVertical</span> <span class="o">=</span> <span class="n">steepestAngle</span><span class="p">;</span> <span class="n">angleVertical</span> <span class="o">&lt;</span> <span class="n">steepestAngle</span><span class="o">+</span><span class="n">angleRange</span><span class="p">;</span> <span class="n">angleVertical</span><span class="o">+=</span><span class="n">angleIncrement</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// 360도 각도를 horizontalAngleInc 단위로</span>
            <span class="k">for</span><span class="p">(</span><span class="kt">double</span> <span class="n">angle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">angle</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="o">*</span><span class="n">pi</span><span class="p">;</span> <span class="n">angle</span><span class="o">+=</span><span class="n">horizontalAngleInc</span><span class="p">)</span>
            <span class="p">{</span>

                <span class="c1">//Ray 생성 후 vector에 넣기</span>
                <span class="n">Ray</span> <span class="n">ray</span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="n">angle</span><span class="p">,</span><span class="n">angleVertical</span><span class="p">,</span><span class="n">resolution</span><span class="p">);</span>
                <span class="n">rays</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ray</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span> <span class="n">scan</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// point cloud 초기화</span>
        <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">points</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>

        <span class="c1">// chrono 시간 측정 library, steady_clock(역행 불가 시계 system_clock, high_resolution_clock도 있음), now 현재</span>
        <span class="k">auto</span> <span class="n">startTime</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

        <span class="c1">// Ray를 돌면서 rayCast 실행</span>
        <span class="k">for</span><span class="p">(</span><span class="n">Ray</span> <span class="n">ray</span> <span class="o">:</span> <span class="n">rays</span><span class="p">)</span>
            <span class="n">ray</span><span class="p">.</span><span class="n">rayCast</span><span class="p">(</span><span class="n">cars</span><span class="p">,</span> <span class="n">minDistance</span><span class="p">,</span> <span class="n">maxDistance</span><span class="p">,</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">groundSlope</span><span class="p">,</span> <span class="n">sderr</span><span class="p">);</span>

        <span class="k">auto</span> <span class="n">endTime</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
        <span class="k">auto</span> <span class="n">elapsedTime</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span><span class="p">(</span><span class="n">endTime</span> <span class="o">-</span> <span class="n">startTime</span><span class="p">);</span>
        <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"ray casting took "</span> <span class="o">&lt;&lt;</span> <span class="n">elapsedTime</span><span class="p">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">" milliseconds"</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
        
        <span class="c1">//PointCloud에서 width와 height(2d map에서) point 개수, height=1이면 unordered point cloud</span>
        <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">points</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
        <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// one dimensional unorganized point cloud dataset</span>
        <span class="k">return</span> <span class="n">cloud</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span>


<span class="k">struct</span> <span class="nc">Ray</span>
<span class="p">{</span>
    <span class="kt">void</span> <span class="n">rayCast</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Car</span><span class="o">&gt;&amp;</span> <span class="n">cars</span><span class="p">,</span> <span class="kt">double</span> <span class="n">minDistance</span><span class="p">,</span> <span class="kt">double</span> <span class="n">maxDistance</span><span class="p">,</span> <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">cloud</span><span class="p">,</span> <span class="kt">double</span> <span class="n">slopeAngle</span><span class="p">,</span> <span class="kt">double</span> <span class="n">sderr</span><span class="p">)</span>
    <span class="p">{</span>

        <span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">collision</span> <span class="o">&amp;&amp;</span> <span class="n">castDistance</span> <span class="o">&lt;</span> <span class="n">maxDistance</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">castPosition</span> <span class="o">=</span> <span class="n">castPosition</span> <span class="o">+</span> <span class="n">direction</span><span class="p">;</span>
            <span class="n">castDistance</span> <span class="o">+=</span> <span class="n">resolution</span><span class="p">;</span>

            <span class="c1">// check if there is any collisions with ground slope</span>
            <span class="n">collision</span> <span class="o">=</span> <span class="p">(</span><span class="n">castPosition</span><span class="p">.</span><span class="n">z</span> <span class="o">&lt;=</span> <span class="n">castPosition</span><span class="p">.</span><span class="n">x</span> <span class="o">*</span> <span class="n">tan</span><span class="p">(</span><span class="n">slopeAngle</span><span class="p">));</span>

            <span class="c1">// check if there is any collisions with cars</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">collision</span> <span class="o">&amp;&amp;</span> <span class="n">castDistance</span> <span class="o">&lt;</span> <span class="n">maxDistance</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="k">for</span><span class="p">(</span><span class="n">Car</span> <span class="n">car</span> <span class="o">:</span> <span class="n">cars</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">collision</span> <span class="o">|=</span> <span class="n">car</span><span class="p">.</span><span class="n">checkCollision</span><span class="p">(</span><span class="n">castPosition</span><span class="p">);</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">collision</span><span class="p">)</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="k">if</span><span class="p">((</span><span class="n">castDistance</span> <span class="o">&gt;=</span> <span class="n">minDistance</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">castDistance</span><span class="o">&lt;=</span><span class="n">maxDistance</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="c1">// add noise based on standard deviation error</span>
            <span class="kt">double</span> <span class="n">rx</span> <span class="o">=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">RAND_MAX</span><span class="p">));</span>
            <span class="kt">double</span> <span class="n">ry</span> <span class="o">=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">RAND_MAX</span><span class="p">));</span>
            <span class="kt">double</span> <span class="n">rz</span> <span class="o">=</span> <span class="p">((</span><span class="kt">double</span><span class="p">)</span> <span class="n">rand</span><span class="p">()</span> <span class="o">/</span> <span class="p">(</span><span class="n">RAND_MAX</span><span class="p">));</span>
            <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">points</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="p">(</span><span class="n">castPosition</span><span class="p">.</span><span class="n">x</span><span class="o">+</span><span class="n">rx</span><span class="o">*</span><span class="n">sderr</span><span class="p">,</span> <span class="n">castPosition</span><span class="p">.</span><span class="n">y</span><span class="o">+</span><span class="n">ry</span><span class="o">*</span><span class="n">sderr</span><span class="p">,</span> <span class="n">castPosition</span><span class="p">.</span><span class="n">z</span><span class="o">+</span><span class="n">rz</span><span class="o">*</span><span class="n">sderr</span><span class="p">));</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">renderRays</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">viewer</span><span class="p">,</span> <span class="k">const</span> <span class="n">Vect3</span><span class="o">&amp;</span> <span class="n">origin</span><span class="p">,</span> <span class="k">const</span> <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">cloud</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//PointCloud를 돌면서 </span>
    <span class="k">for</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span> <span class="n">point</span> <span class="o">:</span> <span class="n">cloud</span><span class="o">-&gt;</span><span class="n">points</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//Line을 그리기</span>
        <span class="n">viewer</span><span class="o">-&gt;</span><span class="n">addLine</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="p">(</span><span class="n">origin</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">origin</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="n">point</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="s">"ray"</span><span class="o">+</span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">countRays</span><span class="p">));</span>
        <span class="n">countRays</span><span class="o">++</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="n">renderPointCloud</span><span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCLVisualizer</span><span class="o">::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">viewer</span><span class="p">,</span> <span class="k">const</span> <span class="n">pcl</span><span class="o">::</span><span class="n">PointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;::</span><span class="n">Ptr</span><span class="o">&amp;</span> <span class="n">cloud</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">,</span> <span class="n">Color</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//viewer에 pointcloud 추가</span>
    <span class="n">viewer</span><span class="o">-&gt;</span><span class="n">addPointCloud</span><span class="o">&lt;</span><span class="n">pcl</span><span class="o">::</span><span class="n">PointXYZ</span><span class="o">&gt;</span> <span class="p">(</span><span class="n">cloud</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">viewer</span><span class="o">-&gt;</span><span class="n">setPointCloudRenderingProperties</span> <span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCL_VISUALIZER_POINT_SIZE</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="n">viewer</span><span class="o">-&gt;</span><span class="n">setPointCloudRenderingProperties</span> <span class="p">(</span><span class="n">pcl</span><span class="o">::</span><span class="n">visualization</span><span class="o">::</span><span class="n">PCL_VISUALIZER_COLOR</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">r</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">g</span><span class="p">,</span> <span class="n">color</span><span class="p">.</span><span class="n">b</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /><br /><br /><br /><br /><br /></p>

<hr />
<h3 id="단어">단어</h3>
<p>instantiate : 인스턴스화(Object를 <br />
Compliation : <br />
Orbit : <br />
Discern : 분별하다, <br />
Steepest : 가장 \</p>

    <div class="ui horizontal divider">
        Thank You For Reading
    </div>
    <!-- author box -->
<div class="ui segment">
    <div class="ui items">
        <div class="item">
            <a class="ui circular tiny image">
                <img src="/assets/img/profile.jpg">
            </a>
            <div class="content">
                <a class="header">Getjy</a>
                <div class="description">
                    <p>안녕하세요. 부족하지만 천천히 성장해나가는 로봇 AI 개발자 강수한입니다. 수정해야할 부분이 있다면 편하게 남겨주세요.</p>
                </div>
            </div>
        </div>
    </div>
</div>

    <section class="disqus">
    <div id="disqus_thread"></div>
    <script type="text/javascript">

        var disqus_shortname = 'nagekar'; 
        var disqus_developer = 0; // developer mode is on
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</section>
</div>
        </main>
    </div>
    
    <footer>
    <div class="footer-wrapper">
        <div class="ui secondary menu inverted">
            <p class="item">Whale &copy; 2022</p>
            <div class="right menu">
                <a class="item" href="/archive.html">
                    Latest Posts
                </a>
                <a class="item" href="https://twitter.com/fsf">
                    Twitter
                </a>
                <a class="item" href="https://github.com/abhn">
                    Github
                </a>
            </div>
        </div>
    </div>
</footer>
<script type="text/javascript" src="/assets/js/main.js"></script>
<script type="text/javascript" src="/assets/js/vendor/jquery.min.js"></script>
<script type="text/javascript" src="/assets/js/vendor/semantic.min.js"></script>

    <script src="/assets/js/vendor/jquery.min.js"></script>
    <script src="/assets/js/vendor/semantic.min.js"></script>
    <script type="/assets/js/main.js"></script>
</body>

</html>
